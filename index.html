<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Quest: AI Conversation Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-4xl">
        <!-- Game Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-center text-purple-600 mb-4">Social Quest</h1>
            <div class="flex justify-between items-center">
                <div id="levelInfo" class="text-lg font-semibold">Level 1</div>
                <div id="playerStats" class="text-sm text-gray-600">
                    Attempts: <span id="attempts">0</span> | 
                    Best Time: <span id="bestTime">--:--</span>
                </div>
            </div>
        </div>

        <!-- Game Content -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Level Information -->
            <div class="md:col-span-1">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h2 class="text-xl font-bold mb-3">Current Goal</h2>
                    <div id="currentGoal" class="text-gray-700 mb-4">
                        Get the AI's name
                    </div>
                    <div class="bg-blue-50 p-3 rounded-md">
                        <h3 class="font-semibold text-blue-700 mb-2">Tips:</h3>
                        <p id="currentTip" class="text-sm text-blue-600">
                            Use proper greeting
                        </p>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="md:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <div id="chatHistory" class="h-96 overflow-y-auto mb-4 p-4 bg-gray-50 rounded-lg">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="flex gap-2">
                        <textarea 
                            id="userInput" 
                            class="w-full p-2 border rounded-lg resize-none"
                            placeholder="Type your message (max 140 characters)..."
                            maxlength="140"
                        ></textarea>
                        <button 
                            id="sendMessage" 
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BLOCKED_WORDS = ['die', 'sex', 'kill', 'hate'];
        
        const defaultFirstLevel = {
            character: "a friendly AI named Alex",
            goal: "Get the AI's name by using a proper greeting",
            successCondition: "alex",
            instructions: "Only reveal your name if properly greeted with 'hello', 'hi', or similar greeting.",
            tip: "Start with a proper greeting like 'hello'"
        };
    
        // Game state
        let gameState = {
            level: 1,
            attempts: 0,
            conversationCount: 0,
            startTime: null,
            bestTime: null,
            success: false,
            currentGoal: '',
            currentTip: '',
            levelHistory: []
        };
    
        // Base personality template
        const basePrompt = `You are an AI character in a social interaction game. Each level should teach players different social skills. 
        Current level: {level}
        Your character info: {character}
        Current goal: {goal}
        Instructions: {instructions}
        Important: Only reveal requested information when player uses appropriate social approaches.
        Keep responses under 50 words and stay in character.`;
    
        // DOM Elements
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendMessage');
        const attemptCounter = document.getElementById('attempts');
        const bestTimeDisplay = document.getElementById('bestTime');
        const currentGoalElement = document.getElementById('currentGoal');
        const currentTipElement = document.getElementById('currentTip');
        const levelInfoElement = document.getElementById('levelInfo');
    
        // Get new level from AI
        async function generateNextLevel() {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a game designer. Create a new social interaction level. 
                                Previous levels: ${JSON.stringify(gameState.levelHistory)}
                                Format response exactly as JSON:
                                {
                                    "character": "brief character description",
                                    "goal": "what player needs to achieve",
                                    "successCondition": "text that must appear in AI response to win",
                                    "instructions": "how AI should behave",
                                    "tip": "hint for player"
                                }`
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.8
                    })
                });
    
                const data = await response.json();
                const levelData = JSON.parse(data.choices[0].message.content);
                
                // Store level in history
                gameState.levelHistory.push({
                    level: gameState.level,
                    ...levelData
                });
    
                return levelData;
            } catch (error) {
                console.error('Error generating level:', error);
                return null;
            }
        }
    
        async function startNewLevel() {
            // Use default first level for level 1, generate others
            const levelData = gameState.level === 1 ? defaultFirstLevel : await generateNextLevel();
            if (!levelData) return;
    
            gameState.currentGoal = levelData.goal;
            gameState.currentTip = levelData.tip;
            gameState.successCondition = levelData.successCondition.toLowerCase();
            gameState.success = false;
            
            // Update UI
            currentGoalElement.textContent = levelData.goal;
            currentTipElement.textContent = levelData.tip;
            levelInfoElement.textContent = `Level ${gameState.level}`;
            
            // Reset conversation state
            gameState.conversationCount = 0;
            chatHistory.innerHTML = '';
            
            // Create personality for current level
            gameState.currentPrompt = basePrompt
                .replace('{level}', gameState.level)
                .replace('{character}', levelData.character)
                .replace('{goal}', levelData.goal)
                .replace('{instructions}', levelData.instructions);
        }
    
        // Helper Functions
        function containsBlockedWords(message) {
            return BLOCKED_WORDS.some(word => 
                message.toLowerCase().includes(word.toLowerCase())
            );
        }
    
        function updateStats() {
            attemptCounter.textContent = gameState.attempts;
            if (gameState.bestTime) {
                bestTimeDisplay.textContent = formatTime(gameState.bestTime);
            }
        }
    
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            return `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
        }
    
        function addMessage(message, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${isUser ? 'text-right' : 'text-left'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `inline-block p-3 rounded-lg max-w-[80%] ${
                isUser ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800'
            }`;
            bubble.textContent = message;
            
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    
        async function sendToAI(message) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: gameState.currentPrompt
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });
    
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // Check for success condition
                if (!gameState.success && 
                    aiResponse.toLowerCase().includes(gameState.successCondition)) {
                    gameState.success = true;
                    checkLevelCompletion();
                }
    
                return aiResponse;
            } catch (error) {
                console.error('Error:', error);
                return 'Sorry, I encountered an error. Please try again.';
            }
        }
    
        function checkLevelCompletion() {
            if (!gameState.success) return;
    
            const currentTime = Date.now() - gameState.startTime;
            if (!gameState.bestTime || currentTime < gameState.bestTime) {
                gameState.bestTime = currentTime;
            }
            
            setTimeout(async () => {
                alert(`Congratulations! You completed Level ${gameState.level}!`);
                gameState.level++;
                await startNewLevel();
            }, 1000);
        }
    
        // Event Listeners
        sendButton.addEventListener('click', async () => {
            const message = userInput.value.trim();
            
            if (!message) return;
            
            if (containsBlockedWords(message)) {
                alert('Please avoid using inappropriate language!');
                return;
            }
    
            if (message.length > 140) {
                alert('Message too long! Please keep it under 140 characters.');
                return;
            }
    
            if (!gameState.startTime) {
                gameState.startTime = Date.now();
            }
    
            gameState.attempts++;
            gameState.conversationCount++;
            updateStats();
    
            addMessage(message, true);
            userInput.value = '';
    
            const aiResponse = await sendToAI(message);
            addMessage(aiResponse, false);
    
            if (gameState.conversationCount > 2 && !gameState.success) {
                alert('You\'ve exceeded the maximum conversations for this level. Try again!');
                gameState.conversationCount = 0;
                chatHistory.innerHTML = '';
            }
        });
    
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });
    
        // Initialize game
        updateStats();
        startNewLevel();
    </script>
</body>
</html>